<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JIAICB (V0.71)</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; margin: 0; display: flex; flex-direction: column; height: 100vh; }
  #chat { flex: 1; padding: 1em; overflow-y: auto; background: #222; border-bottom: 1px solid #333; text-align: left; }
  .message {
  display: block;
  padding: 0.5em 1em;
  border-radius: 15px;
  margin: 0.25em 0;
  max-width: 70%;
  word-wrap: break-word;
  position: relative;
}

.user {
  align-self: flex-end;
  background: #6272a4;
  color: #fff;
  text-align: left;
}

.ai {
  align-self: flex-start;
  background: #50fa7b;
  color: #111;
  text-align: left;
}
  .system { text-align: left; font-style: italic; color: #ff5555; }
  .sender { font-weight: bold; }
  .messageText { display: block; margin-top: 0.25em; }
  #inputArea { display: flex; padding: .5em; background: #111; }
  #prompt { flex: 1; padding: .5em; background: #222; color: #fff; border: 1px solid #444; border-radius: 5px; }
  button { margin-left: .5em; padding: .5em 1em; border: none; border-radius: 5px; background: #6272a4; color: #fff; cursor: pointer; }
  button:hover { background: #7082c4; }
  #clearMemory { background: red; color: white; }
  #historyBtn { background: #ffee8c; color: black; }
  /* Iframe styles */
  #historyFrame { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:95%; height:80%; border:2px solid #50fa7b; background:#111; color:white; overflow-y:auto; z-index:9999; }
  #closeHistory { display:none; position:fixed; top:5%; right:5%; z-index:10000; padding:.5em 1em; border:none; border-radius:5px; background:#ff5555; color:white; cursor:pointer; }
  .highlight { background-color: yellow; color: black; }
  #searchBar {
    padding: 0.5em;
    margin: 0.5em;
    width: 80%;
    border-radius: 5px;
    border: 1px solid #444;
    background: #222;
    color: #fff;
  }
</style>
</head>
<body>
<button id="modsBtn" style="margin-left:10px;">Custom Themes</button>

<div id="modsPanel" style="
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  width:400px;
  background:#222;
  color:white;
  border:2px solid #50fa7b;
  border-radius:10px;
  padding:1em;
  z-index:10000;
  box-shadow:0 0 20px #000;
">
  <h3 style="margin-top:0; text-align:center;">Custom Theme Editor</h3>
  <div id="customThemeEditor">
    <label>Background: <input type="color" id="background" class="colorInput" value="#111"></label><br>
    <label>Chat Background: <input type="color" id="chatBackground" class="colorInput" value="#222"></label><br>
    <label>User Bubble: <input type="color" id="userBubble" class="colorInput" value="#6272a4"></label><br>
    <label>AI Bubble: <input type="color" id="aiBubble" class="colorInput" value="#50fa7b"></label><br>
    <label>System Text: <input type="color" id="systemText" class="colorInput" value="#ff5555"></label><br>
    <label>Input Background: <input type="color" id="inputBackground" class="colorInput" value="#222"></label><br>
    <label>Input Text: <input type="color" id="inputText" class="colorInput" value="#ffffff"></label><br><br>
    <button id="applyCustomTheme">Apply</button>
    <button id="saveTheme">Export</button>
    <input type="file" id="loadTheme" accept=".json" style="color:white;" />
  </div>
  <button id="closeMods" style="
    position:absolute; top:8px; right:8px;
    background:red; border:none; color:white;
    border-radius:5px; padding:2px 6px; cursor:pointer;
  ">X</button>
</div>
<input id="searchBar" type="text" placeholder="Search messages..." />
<select id="themeSelector">
  <optgroup label="Classic Themes">
    <option value="dark">Dark</option>
    <option value="light">Light</option>
    <option value="sunset">Sunset</option>
  </optgroup>
  <optgroup label="Color Themes">
    <option value="red">Red</option>
    <option value="orange">Orange</option>
    <option value="yellow">Yellow</option>
    <option value="green">Green</option>
    <option value="teal">Teal</option>
    <option value="blue">Blue</option>
    <option value="purple">Purple</option>
    <option value="pink">Pink</option>
  </optgroup>
</select>

<div id="chat"></div>

<div id="inputArea">
  <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
  <button id="clearMemory">Clear Memory</button>
  <button id="historyBtn">History</button>
</div>

<iframe id="historyFrame"></iframe>
<button id="closeHistory">Close History</button>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const chatBox = document.getElementById("chatBox");
    const inputBox = document.getElementById("userInput");
    const typingIndicator = document.createElement("div");
    const modsButton = document.getElementById("modsButton");
    const themeButton = document.getElementById("themeButton");

    typingIndicator.className = "typing-indicator";
    typingIndicator.textContent = "Typing...";
    typingIndicator.style.display = "none";
    chatBox.appendChild(typingIndicator);

    // =========================
    // Theme System
    // =========================
    const themes = {
        light: {
            bg: "#f4f4f4",
            userBubble: "#d1e7ff",
            aiBubble: "#e8e8e8",
            accent: "#007bff",
            text: "#222"
        },
        dark: {
            bg: "#1e1e1e",
            userBubble: "#4a90e2",
            aiBubble: "#2c2c2c",
            accent: "#007bff",
            text: "#fff"
        },
        red: {
            bg: "#2b0000",
            userBubble: "#ff4d4d",
            aiBubble: "#661111",
            accent: "#ff0000",
            text: "#fff"
        },
        green: {
            bg: "#002b00",
            userBubble: "#00cc44",
            aiBubble: "#004d00",
            accent: "#00ff66",
            text: "#fff"
        },
        blue: {
            bg: "#001f3f",
            userBubble: "#3399ff",
            aiBubble: "#003366",
            accent: "#3399ff",
            text: "#fff"
        }
    };

    function applyTheme(theme) {
        document.documentElement.style.setProperty("--bg", theme.bg);
        document.documentElement.style.setProperty("--userBubble", theme.userBubble);
        document.documentElement.style.setProperty("--aiBubble", theme.aiBubble);
        document.documentElement.style.setProperty("--accent", theme.accent);
        document.documentElement.style.setProperty("--text", theme.text);
        typingIndicator.style.background = "var(--aiBubble)";
        typingIndicator.style.color = "var(--text)";
    }

    function loadTheme(name) {
        const stored = localStorage.getItem(`theme_${name}`);
        if (stored) {
            const theme = JSON.parse(stored);
            applyTheme(theme);
        } else if (themes[name]) {
            applyTheme(themes[name]);
        }
    }

    themeButton.addEventListener("click", () => {
        const keys = Object.keys(themes);
        let current = localStorage.getItem("currentTheme") || "light";
        let next = keys[(keys.indexOf(current) + 1) % keys.length];
        localStorage.setItem("currentTheme", next);
        loadTheme(next);
    });

    loadTheme(localStorage.getItem("currentTheme") || "light");

    // =========================
    // Custom Theme Modal
    // =========================
    const modal = document.createElement("div");
    modal.id = "themeModal";
    modal.style.display = "none";
    modal.style.position = "fixed";
    modal.style.top = "50%";
    modal.style.left = "50%";
    modal.style.transform = "translate(-50%, -50%)";
    modal.style.background = "var(--bg)";
    modal.style.border = "2px solid var(--accent)";
    modal.style.borderRadius = "20px";
    modal.style.padding = "20px";
    modal.style.zIndex = "9999";
    modal.style.width = "300px";
    modal.style.color = "var(--text)";
    modal.style.boxShadow = "0 0 20px rgba(0,0,0,0.3)";
    modal.innerHTML = `
        <h2 style="text-align:center;">🎨 Custom Theme</h2>
        <label>Name:</label>
        <input id="themeName" type="text" style="width:100%;margin-bottom:8px;"><br>
        <label>Background:</label>
        <input id="bgColor" type="color" style="width:100%;margin-bottom:8px;"><br>
        <label>User Bubble:</label>
        <input id="userBubbleColor" type="color" style="width:100%;margin-bottom:8px;"><br>
        <label>AI Bubble:</label>
        <input id="aiBubbleColor" type="color" style="width:100%;margin-bottom:8px;"><br>
        <label>Accent:</label>
        <input id="accentColor" type="color" style="width:100%;margin-bottom:8px;"><br>
        <label>Text:</label>
        <input id="textColor" type="color" style="width:100%;margin-bottom:8px;"><br>
        <button id="previewTheme" style="width:100%;margin-top:10px;">Preview</button>
        <button id="saveTheme" style="width:100%;margin-top:5px;">Save</button>
        <button id="closeThemeModal" style="width:100%;margin-top:5px;">Close</button>
    `;
    document.body.appendChild(modal);

    modsButton.addEventListener("click", () => {
        modal.style.display = "block";
    });

    document.getElementById("closeThemeModal").onclick = () => {
        modal.style.display = "none";
    };

    document.getElementById("previewTheme").onclick = () => {
        const theme = {
            bg: document.getElementById("bgColor").value,
            userBubble: document.getElementById("userBubbleColor").value,
            aiBubble: document.getElementById("aiBubbleColor").value,
            accent: document.getElementById("accentColor").value,
            text: document.getElementById("textColor").value
        };
        applyTheme(theme);
    };

    document.getElementById("saveTheme").onclick = () => {
        const name = document.getElementById("themeName").value.trim() || "Custom";
        const theme = {
            name,
            bg: document.getElementById("bgColor").value,
            userBubble: document.getElementById("userBubbleColor").value,
            aiBubble: document.getElementById("aiBubbleColor").value,
            accent: document.getElementById("accentColor").value,
            text: document.getElementById("textColor").value
        };
        localStorage.setItem(`theme_${name}`, JSON.stringify(theme));
        localStorage.setItem("currentTheme", name);
        applyTheme(theme);
        alert(`Theme "${name}" saved!`);
        modal.style.display = "none";
    };

    // =========================
    // Chat Functionality
    // =========================
    function addMessage(sender, text) {
        const bubble = document.createElement("div");
        bubble.className = `message ${sender}`;
        bubble.textContent = text;
        bubble.style.background = sender === "user" ? "var(--userBubble)" : sender === "ai" ? "var(--aiBubble)" : "transparent";
        bubble.style.color = "var(--text)";
        bubble.style.alignSelf = sender === "user" ? "flex-end" : "flex-start";
        bubble.style.margin = "8px";
        bubble.style.padding = "10px 14px";
        bubble.style.borderRadius = "18px";
        bubble.style.maxWidth = "75%";
        bubble.style.animation = "fadeIn 0.3s ease";
        chatBox.insertBefore(bubble, typingIndicator);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    function showTyping() {
        typingIndicator.style.background = "var(--aiBubble)";
        typingIndicator.style.color = "var(--text)";
        typingIndicator.style.display = "block";
    }

    function hideTyping() {
        typingIndicator.style.display = "none";
    }

    async function sendMessage() {
        const text = inputBox.value.trim();
        if (!text) return;
        addMessage("user", text);
        inputBox.value = "";
        showTyping();

        try {
            const resp = await fetch(`/api?input=${encodeURIComponent(text)}`);
            const reply = await resp.text();
            hideTyping();
            addMessage("ai", reply);
        } catch {
            hideTyping();
            addMessage("system", "⚠️ Connection error.");
        }
    }

    inputBox.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendMessage();
    });
});
</script>
</body>
</html>
