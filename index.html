<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>JIAICB (V0.74) — Fixed</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --transition: 0.35s ease; }
  body { font-family: sans-serif; background: #111; color: #eee; margin: 0; display:flex; flex-direction:column; height:100vh; transition: background var(--transition), color var(--transition); }
  #topbar { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; background:transparent; }
  #chat { flex: 1; padding: 1rem; overflow-y: auto; background: #222; border-top:1px solid #333; border-bottom: 1px solid #333; transition: background var(--transition); }
  .message { display:block; padding:.5rem .8rem; border-radius:14px; margin:.35rem 0; max-width:72%; word-wrap:break-word; position:relative; opacity:0; transform:translateY(10px); transition: opacity .28s ease, transform .28s ease; }
  .user { margin-left:auto; background:#6272a4; color:#fff; text-align:left; }
  .ai { margin-right:auto; background:#50fa7b; color:#111; text-align:left; }
  .system { font-style:italic; color:#ff5555; text-align:left; }
  .message b { display:inline-block; margin-right:.4rem; }
  .messageText { display:block; margin-top:.25rem; }
  #inputArea { display:flex; gap:.5rem; padding:.6rem; align-items:center; background:#111; }
  #prompt { flex:1; padding:.5rem; border-radius:6px; background:#222; color:#fff; border:1px solid #444; transition: background var(--transition), color var(--transition); }
  button { padding:.45rem .8rem; border-radius:6px; border:none; background:#6272a4; color:#fff; cursor:pointer; transition: background .2s; }
  button:hover { filter:brightness(1.05); }
  #clearMemory { background:#d9534f; }
  #historyBtn { background:#ffee8c; color:#111; }
  #modsbtn { background:#50fa7b; color:#111; }
  #searchBar { padding:.45rem; margin:.4rem; width:60%; border-radius:6px; border:1px solid #444; background:#222; color:#fff; }

  /* modal */
  #customThemeModal { display:none; position:fixed; z-index:12000; top:50%; left:50%; transform:translate(-50%,-50%); width:360px; max-width:95%; background:#111; border:2px solid #50fa7b; border-radius:12px; padding:1rem; box-shadow:0 6px 30px rgba(0,0,0,.6); }
  #customThemeModal h3 { margin:0 0 .5rem 0; text-align:center; }
  #customThemeModal label{display:block;margin-top:.35rem;font-size:.9rem}
  #customThemeModal input[type="color"]{width:100%;height:34px;border-radius:6px;border:1px solid #333;padding:0}
  #customThemeList { list-style:none; padding:0; margin: .5rem 0; max-height:150px; overflow:auto; border:1px solid #333; border-radius:6px; padding:.4rem; }
  #customThemeList li { display:flex; justify-content:space-between; align-items:center; padding:.25rem .4rem; margin:.25rem 0; background:#161616; border-radius:6px; }
  #customThemeList button{ margin-left:.4rem; padding:.25rem .5rem; }

  /* iframe history */
  #historyFrame { display:none; position:fixed; z-index:11000; top:50%; left:50%; transform:translate(-50%,-50%); width:92%; height:78%; border:2px solid #50fa7b; background:#111; border-radius:8px; }
  #closeHistory { display:none; position:fixed; z-index:11001; top:6%; right:6%; padding:.5rem .8rem; border-radius:6px; background:#ff5555; color:#fff; }

  /* small screens */
  @media (max-width:600px){
    #searchBar { width:48%; }
    #customThemeModal { width:92%; }
  }
</style>
</head>
<body>
  <div id="topbar">
    <button id="modsbtn">Custom Themes</button>
    <input id="searchBar" placeholder="Search messages..." />
    <select id="themeSelector" aria-label="Select theme">
      <optgroup label="Classic Themes">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="sunset">Sunset</option>
      </optgroup>
      <optgroup label="Color Themes">
        <option value="red">Red</option>
        <option value="orange">Orange</option>
        <option value="yellow">Yellow</option>
        <option value="green">Green</option>
        <option value="teal">Teal</option>
        <option value="blue">Blue</option>
        <option value="purple">Purple</option>
        <option value="pink">Pink</option>
      </optgroup>
    </select>
  </div>

  <div id="chat" aria-live="polite"></div>

  <div id="inputArea">
    <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
    <button id="sendBtn">Send</button>
    <button id="clearMemory">Clear Memory</button>
    <button id="historyBtn">History</button>
    <button id="exportChatBtn" style="background:#00bfff;color:#fff;">Export Chat</button>
    <button id="importChatBtn" style="background:#50fa7b;color:#111;">Import Chat</button>
    <input id="importChatFile" type="file" accept="application/json" style="display:none">
  </div>

  <iframe id="historyFrame" title="Chat History"></iframe>
  <button id="closeHistory">Close History</button>

  <!-- Custom Theme Modal (hidden initially) -->
  <div id="customThemeModal" role="dialog" aria-hidden="true">
    <h3>Custom Theme Creator</h3>

    <label>Background</label>
    <input id="bgColor" type="color" value="#111">

    <label>Chat Background</label>
    <input id="chatBgColor" type="color" value="#222">

    <label>User Bubble</label>
    <input id="userColor" type="color" value="#6272a4">

    <label>AI Bubble</label>
    <input id="aiColor" type="color" value="#50fa7b">

    <label>System Text</label>
    <input id="systemColor" type="color" value="#ff5555">

    <h4 style="margin:.5rem 0 0 0">Saved Themes</h4>
    <ul id="customThemeList"></ul>

    <div style="display:flex; gap:.5rem; margin-top:.6rem; justify-content:center;">
      <button id="previewTheme">Preview</button>
      <button id="saveTheme">Save</button>
      <button id="exportThemeBtn" style="background:#00bfff;color:#fff;">Export Theme</button>
      <button id="importThemeBtn" style="background:#50fa7b;color:#111;">Import Theme</button>
      <input id="importThemeFile" type="file" accept="application/json" style="display:none;">
      <button id="closeTheme" style="background:#ff5555;color:#fff;">Close</button>
    </div>
  </div>

<script>
/* ===============================
   Global Setup
=============================== */
const chat = document.getElementById("chat");
const msgInput = document.getElementById("msgInput");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const historyBtn = document.getElementById("historyBtn");
const importChatBtn = document.getElementById("importChatBtn");
const importChatFile = document.getElementById("importChatFile");
const exportChatBtn = document.getElementById("exportChatBtn");
const modsBtn = document.getElementById("modsBtn");
const themeSelect = document.getElementById("themeSelect");

let chatHistory = JSON.parse(localStorage.getItem("chatHistory")) || [];

/* ===============================
   Core Chat Logic
=============================== */
function addMessage(sender, text, cls, options = { save: true }) {
  const msg = document.createElement("div");
  msg.className = `msg ${cls}`;
  msg.innerHTML = `<strong>${sender}:</strong> ${text}`;
  chat.appendChild(msg);
  chat.scrollTop = chat.scrollHeight;

  if (options.save) {
    chatHistory.push({ sender, text, cls });
    localStorage.setItem("chatHistory", JSON.stringify(chatHistory));
  }
}

async function sendMessage() {
  const text = msgInput.value.trim();
  if (!text) return;
  addMessage("You", text, "user");

  msgInput.value = "";
  chat.scrollTop = chat.scrollHeight;

  try {
    const response = await fetch(`/api?input=${encodeURIComponent(text)}`);
    const reply = await response.text();
    addMessage("AI", reply, "ai");
  } catch (err) {
    addMessage("System", "(Error contacting AI)", "system");
  }
}

/* ===============================
   Event Handlers
=============================== */
sendBtn.addEventListener("click", sendMessage);
msgInput.addEventListener("keydown", e => { if (e.key === "Enter") sendMessage(); });

clearBtn.addEventListener("click", async () => {
  if (!confirm("Are you sure you want to clear the chat?")) return;
  chat.innerHTML = "";
  chatHistory = [];
  localStorage.removeItem("chatHistory");
  addMessage("System", "Memory cleared!", "system", { save: false });
  await fetch("/api?clear=true");
});

historyBtn.addEventListener("click", () => {
  const frame = document.getElementById("historyFrame");
  if (frame) frame.src = `/api?view=history&${Date.now()}`;
  else window.open(`/api?view=history`, "_blank");
});

/* ===============================
   Chat Import / Export
=============================== */
exportChatBtn.addEventListener("click", () => {
  const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "chat_history.json";
  a.click();
});

importChatBtn.addEventListener("click", () => importChatFile.click());

importChatFile.addEventListener("change", async e => {
  const file = e.target.files[0];
  if (!file) return;

  const proceed = confirm("⚠️ Importing will replace the current conversation memory. Continue?");
  if (!proceed) { e.target.value = ''; return; }

  try {
    const text = await file.text();
    const importedChat = JSON.parse(text);

    chat.innerHTML = "";
    chatHistory = [];
    localStorage.removeItem("chatHistory");

    importedChat.forEach(msg => addMessage(msg.sender, msg.text, msg.cls, { save: false }));
    chatHistory = importedChat;
    localStorage.setItem("chatHistory", JSON.stringify(chatHistory));

    await fetch("/api", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ memory: chatHistory })
    });

    addMessage("System", "Chat imported successfully!", "system", { save: false });
  } catch (err) {
    alert("Invalid or corrupted chat file.");
  } finally {
    e.target.value = "";
  }
});

/* ===============================
   Custom Themes (Mods Menu)
=============================== */
const customThemes = JSON.parse(localStorage.getItem("customThemes")) || {};
function applyTheme(theme) {
  const root = document.documentElement;
  const t = customThemes[theme] || predefinedThemes[theme];
  if (!t) return;
  Object.entries(t).forEach(([key, val]) => root.style.setProperty(`--${key}`, val));
  themeSelect.value = theme;
}

const predefinedThemes = {
  dark: {
    bg: "#0a0a0a",
    text: "#f5f5f5",
    accent: "#1f6feb",
    bubbleUser: "#1e1e1e",
    bubbleAI: "#222",
    bubbleSystem: "#333"
  },
  light: {
    bg: "#ffffff",
    text: "#111111",
    accent: "#0078ff",
    bubbleUser: "#e5e5e5",
    bubbleAI: "#f0f0f0",
    bubbleSystem: "#d0d0d0"
  },
  ocean: {
    bg: "#001f3f",
    text: "#7fdbff",
    accent: "#39cccc",
    bubbleUser: "#0074d9",
    bubbleAI: "#001f3f",
    bubbleSystem: "#005f6b"
  }
};

Object.keys(predefinedThemes).forEach(t => {
  const opt = document.createElement("option");
  opt.value = t;
  opt.textContent = t;
  themeSelect.appendChild(opt);
});

themeSelect.addEventListener("change", e => {
  applyTheme(e.target.value);
  localStorage.setItem("theme", e.target.value);
});

const savedTheme = localStorage.getItem("theme") || "dark";
applyTheme(savedTheme);

/* ===============================
   Mods Menu
=============================== */
modsBtn.addEventListener("click", () => {
  const modal = document.createElement("div");
  modal.className = "modal";
  modal.innerHTML = `
    <div class="modal-content">
      <h2>Custom Theme Editor</h2>
      <p>Create or edit custom color themes.</p>
      <input id="themeName" placeholder="Theme name">
      <textarea id="themeJSON" placeholder='{"bg":"#000","text":"#fff"}'></textarea>
      <button id="saveTheme">Save Theme</button>
      <button id="importTheme">Import Themes</button>
      <input type="file" id="importThemeFile" accept="application/json" hidden>
      <button id="exportTheme">Export Themes</button>
      <button id="closeTheme">Close</button>
    </div>
  `;
  document.body.appendChild(modal);

  const close = () => modal.remove();

  modal.querySelector("#closeTheme").addEventListener("click", close);

  modal.querySelector("#saveTheme").addEventListener("click", () => {
    const name = modal.querySelector("#themeName").value.trim();
    if (!name) return alert("Enter a theme name!");
    try {
      const json = JSON.parse(modal.querySelector("#themeJSON").value);
      customThemes[name] = json;
      localStorage.setItem("customThemes", JSON.stringify(customThemes));
      alert("Theme saved!");
      close();
      location.reload();
    } catch {
      alert("Invalid JSON format.");
    }
  });

  modal.querySelector("#importTheme").addEventListener("click", () =>
    modal.querySelector("#importThemeFile").click()
  );

  modal.querySelector("#importThemeFile").addEventListener("change", async e => {
    const file = e.target.files[0];
    if (!file) return;
    try {
      const text = await file.text();
      Object.assign(customThemes, JSON.parse(text));
      localStorage.setItem("customThemes", JSON.stringify(customThemes));
      alert("Themes imported!");
      close();
      location.reload();
    } catch {
      alert("Invalid file.");
    }
  });

  modal.querySelector("#exportTheme").addEventListener("click", () => {
    const blob = new Blob([JSON.stringify(customThemes, null, 2)], { type: "application/json" });
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "custom_themes.json";
    a.click();
  });
});

/* ===============================
   Load Previous Chat
=============================== */
window.addEventListener("load", () => {
  chatHistory.forEach(msg => addMessage(msg.sender, msg.text, msg.cls, { save: false }));
});
</script>
</body>
</html>
