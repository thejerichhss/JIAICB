<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JIAICB (V0.62)</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; margin: 0; display: flex; flex-direction: column; height: 100vh; }
  #chat { flex: 1; padding: 1em; overflow-y: auto; background: #222; border-bottom: 1px solid #333; text-align: left; }
  .message { display: block; padding: 0.5em 1em; border-radius: 15px; margin: 0.25em 0; max-width: 70%; word-wrap: break-word; position: relative; }
  .user { align-self: flex-end; background: #6272a4; color: #fff; text-align: left; }
  .ai { align-self: flex-start; background: #50fa7b; color: #111; text-align: left; }
  .system { text-align: center; font-style: italic; color: #ff5555; }
  .sender { font-weight: bold; }
  .messageText { display: block; margin-top: 0.25em; }
  #inputArea { display: flex; padding: .5em; background: #111; }
  #prompt { flex: 1; padding: .5em; background: #222; color: #fff; border: 1px solid #444; border-radius: 5px; }
  button { margin-left: .5em; padding: .5em 1em; border: none; border-radius: 5px; background: #6272a4; color: #fff; cursor: pointer; }
  button:hover { background: #7082c4; }
  #clearMemory { background: red; color: white; }
  #historyBtn { background: #ffee8c; color: white; }
  /* Iframe styles */
  #historyFrame { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:95%; height:80%; border:2px solid #50fa7b; background:#111; color:white; overflow-y:auto; z-index:9999; }
  #closeHistory { display:none; position:fixed; top:5%; right:5%; z-index:10000; padding:.5em 1em; border:none; border-radius:5px; background:#ff5555; color:white; cursor:pointer; }
  /* Search highlight */
.highlight {
  background-color: yellow;
  color: black;
}

#searchBar {
  padding: 0.5em;
  margin: 0.5em;
  width: 80%;
  border-radius: 5px;
  border: 1px solid #444;
  background: #222;
  color: #fff;
}
</style>
<script>
let currentTheme = 'dark';

/* --- Utility functions --- */
function decodeEntities(encodedStr) {
  const txt = document.createElement("textarea");
  txt.innerHTML = encodedStr || "";
  return txt.value;
}
function escapeHTML(str) {
  return (str||"").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
}
function applyMarkdown(str) {
  let s = str;
  s = s.replace(/\*\*(.+?)\*\*/g,"<b>$1</b>");
  s = s.replace(/(^|[^*])\*(?!\*)(.+?)\*(?!\*)/g,"$1<i>$2</i>");
  s = s.replace(/(^|[^_])_(.+?)_(?!_)/g,"$1<i>$2</i>");
  return s;
}

/* --- Add messages --- */
function addMessage(sender, text, cls) {
  try {
    const chat = document.getElementById('chat');
    const msgWrapper = document.createElement('div');
    msgWrapper.style.display = 'flex';
    msgWrapper.style.flexDirection = 'column';
    msgWrapper.style.width = '100%';
    
    const msg = document.createElement('div');
    msg.className = `message ${cls}`;

    let formatted;
    if (cls === 'ai') {
      formatted = applyMarkdown(decodeEntities(text)).replace(/\r\n|\r|\n/g, "<br>");
    } else {
      formatted = escapeHTML(text).replace(/\n/g,"<br>");
    }

    const time = new Date();
    const timestamp = `${time.getHours().toString().padStart(2,'0')}:${time.getMinutes().toString().padStart(2,'0')}`;

    msg.innerHTML = `<b>${sender}:</b> <span class="messageText">${formatted}</span> <span style="font-size:0.7em; opacity:0.7; margin-left:0.5em;">${timestamp}</span>`;
    msg.setAttribute('data-original', msg.innerHTML);

    const theme = themes[currentTheme] || themes.dark;
    if (cls === 'user') {
      msg.style.background = theme.userBubble;
      msg.style.color = theme.inputText;
    } else if (cls === 'ai') {
      msg.style.background = theme.aiBubble;
      msg.style.color = theme.inputText;
    } else if (cls === 'system') {
      msg.style.color = theme.systemText;
    }

    msgWrapper.appendChild(msg);
    chat.appendChild(msgWrapper);
    chat.scrollTop = chat.scrollHeight;
  } catch (e) {
    console.error("addMessage error:", e);
  }
}

/* --- Typing indicator --- */
function showTypingIndicator() {
  const chat = document.getElementById('chat');
  if (document.getElementById('typingIndicator')) return;

  const typing = document.createElement('div');
  typing.id = 'typingIndicator';
  typing.className = 'message ai';
  typing.innerHTML = `<b>AI:</b> <span class="messageText">Typing...</span>`;

  const theme = themes[currentTheme] || themes.dark;
  typing.style.background = theme.aiBubble;
  typing.style.color = theme.inputText;

  typing.style.opacity = '0';
  typing.style.transition = 'opacity 0.4s ease';
  chat.appendChild(typing);
  chat.scrollTop = chat.scrollHeight;
  requestAnimationFrame(() => typing.style.opacity = '1');
}

function removeTypingIndicator() {
  const typing = document.getElementById('typingIndicator');
  if (typing) {
    typing.style.transition = 'opacity 0.4s ease';
    typing.style.opacity = '0';
    setTimeout(() => typing.remove(), 400);
  }
}

/* --- Send message --- */
async function sendMessage(){
  try {
    const text = promptInput.value.trim();
    if(!text) return;
    addMessage('You', text,'user');
    promptInput.value=''; promptInput.focus();

    showTypingIndicator();

    // âœ… Use the Flask /api endpoint
    const url = `/api?input=${encodeURIComponent(text)}`;
    const res = await fetch(url, {cache:"no-store"});
    const reply = await res.text();

    removeTypingIndicator();
    addMessage('AI', reply,'ai');
  } catch(e){
    console.error(e);
    removeTypingIndicator();
    addMessage('System','Network or parsing error','system');
  }
}

/* --- DOM elements --- */
const promptInput = document.getElementById('prompt');
const sendBtn = document.getElementById('sendBtn');
const clearBtn = document.getElementById('clearMemory');
const historyBtn = document.getElementById('historyBtn');
const historyFrame = document.getElementById('historyFrame');
const closeHistory = document.getElementById('closeHistory');
const searchBar = document.getElementById('searchBar');

/* --- Event wiring --- */
sendBtn.addEventListener('click', e=>{ e.preventDefault(); sendMessage(); });
promptInput.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); } });
clearBtn.addEventListener('click', async e=>{
  e.preventDefault();
  try{
    await fetch(`/api?clear=true`);
    document.getElementById('chat').innerHTML='';
    addMessage('System','Conversation memory cleared','system');
  } catch(e){console.error(e);}
});

/* --- History iframe --- */
historyBtn.addEventListener('click', async ()=>{
  try {
    historyFrame.src = "/api?view=history";
    historyFrame.style.display = 'block';
    closeHistory.style.display = 'block';
    historyFrame.onload = () => {
      try {
        const doc = historyFrame.contentDocument || historyFrame.contentWindow.document;
        doc.body.style.background = "#111";
        doc.body.style.color = "white";
        doc.body.scrollTop = doc.body.scrollHeight;
      } catch (e) { console.error(e); }
    };
  } catch(e) {
    console.error("History load error:", e);
  }
});
closeHistory.addEventListener('click', () => {
  historyFrame.style.display = 'none';
  closeHistory.style.display = 'none';
});
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    historyFrame.style.display = 'none';
    closeHistory.style.display = 'none';
  }
});

/* --- Search bar --- */
searchBar.addEventListener('input', () => {
  const term = searchBar.value.toLowerCase();
  document.querySelectorAll('#chat .message').forEach(msg => {
    const originalText = msg.getAttribute('data-original') || msg.textContent;
    msg.setAttribute('data-original', originalText);
    if(term && originalText.toLowerCase().includes(term)){
      msg.style.display='inline-block';
      const regex = new RegExp(`(${term})`, 'gi');
      msg.innerHTML = originalText.replace(regex, `<span class="highlight">$1</span>`);
    } else {
      msg.style.display = term ? 'none' : 'inline-block';
      if(!term) msg.innerHTML = originalText;
    }
  });
});

/* --- Themes --- */
const themes = {
  dark:{background:'#111',chatBackground:'#222',userBubble:'#6272a4',aiBubble:'#50fa7b',systemText:'#ff5555',inputBackground:'#222',inputText:'#fff'},
  light:{background:'#f4f4f4',chatBackground:'#fff',userBubble:'#007bff',aiBubble:'#28a745',systemText:'#dc3545',inputBackground:'#fff',inputText:'#000'},
  sunset:{background:'#ffecd1',chatBackground:'#ffe4c4',userBubble:'#ff7f50',aiBubble:'#ffa07a',systemText:'#ff4500',inputBackground:'#fff5e6',inputText:'#333'},
  red:{background:'#2b0000',chatBackground:'#3d0c0c',userBubble:'#ff4d4d',aiBubble:'#ff9999',systemText:'#ffb3b3',inputBackground:'#4d0f0f',inputText:'#fff'},
  orange:{background:'#2b1500',chatBackground:'#3d1f00',userBubble:'#ff7b00',aiBubble:'#ffb366',systemText:'#ffcc99',inputBackground:'#4d2600',inputText:'#fff'},
  yellow:{background:'#2b2b00',chatBackground:'#3d3d00',userBubble:'#ffee00',aiBubble:'#fff57f',systemText:'#fff8b3',inputBackground:'#4d4d00',inputText:'#000'},
  green:{background:'#001f00',chatBackground:'#0c3d0c',userBubble:'#00b33c',aiBubble:'#66ff99',systemText:'#aaffcc',inputBackground:'#004d1a',inputText:'#fff'},
  teal:{background:'#001f1f',chatBackground:'#0c3d3d',userBubble:'#00b3b3',aiBubble:'#66ffff',systemText:'#99ffff',inputBackground:'#004d4d',inputText:'#fff'},
  blue:{background:'#000f33',chatBackground:'#001a4d',userBubble:'#3385ff',aiBubble:'#80b3ff',systemText:'#99ccff',inputBackground:'#002b80',inputText:'#fff'},
  purple:{background:'#1a0033',chatBackground:'#26004d',userBubble:'#9933ff',aiBubble:'#cc99ff',systemText:'#e6ccff',inputBackground:'#330066',inputText:'#fff'},
  pink:{background:'#33001a',chatBackground:'#4d0026',userBubble:'#ff66b3',aiBubble:'#ffb3d9',systemText:'#ffccff',inputBackground:'#660033',inputText:'#fff'}
};

function applyTheme(name) {
  const theme = themes[name] || themes.dark;
  currentTheme = name;

  document.body.style.background = theme.background;
  document.getElementById('chat').style.background = theme.chatBackground;
  document.getElementById('prompt').style.background = theme.inputBackground;
  document.getElementById('prompt').style.color = theme.inputText;

  document.querySelectorAll('.user').forEach(el => el.style.background = theme.userBubble);
  document.querySelectorAll('.ai').forEach(el => el.style.background = theme.aiBubble);
  document.querySelectorAll('.system').forEach(el => el.style.color = theme.systemText);
}

document.getElementById('themeSelector').addEventListener('change', e => {
  const name = e.target.value;
  applyTheme(name);
  localStorage.setItem('theme', name);
});

const savedTheme = localStorage.getItem('theme');
if (savedTheme && themes[savedTheme]) {
  applyTheme(savedTheme);
  document.getElementById('themeSelector').value = savedTheme;
} else {
  applyTheme('dark');
}

promptInput.focus();
</script>

</head>
<body>
<input id="searchBar" type="text" placeholder="Search messages..." />
<select id="themeSelector">
  <optgroup label="Classic Themes">
    <option value="dark">Dark</option>
    <option value="light">Light</option>
    <option value="sunset">Sunset</option>
  </optgroup>
  <optgroup label="Color Themes">
    <option value="red">Red</option>
    <option value="orange">Orange</option>
    <option value="yellow">Yellow</option>
    <option value="green">Green</option>
    <option value="teal">Teal</option>
    <option value="blue">Blue</option>
    <option value="purple">Purple</option>
    <option value="pink">Pink</option>
  </optgroup>
</select>
<div id="chat" role="log" aria-live="polite"></div>

<div id="inputArea">
  <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
  <button id="clearMemory" title="Clear server memory">Clear Memory</button>
  <button id="historyBtn">History</button>
</div>
<iframe id="historyFrame"></iframe>
<button id="closeHistory">Close History</button>
</body>
</html>
