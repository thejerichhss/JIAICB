<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JIAICB (V0.71)</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; margin: 0; display: flex; flex-direction: column; height: 100vh; }
  #chat { flex: 1; padding: 1em; overflow-y: auto; background: #222; border-bottom: 1px solid #333; text-align: left; }
  .message {
  display: block;
  padding: 0.5em 1em;
  border-radius: 15px;
  margin: 0.25em 0;
  max-width: 70%;
  word-wrap: break-word;
  position: relative;
}

.user {
  align-self: flex-end;
  background: #6272a4;
  color: #fff;
  text-align: left;
}

.ai {
  align-self: flex-start;
  background: #50fa7b;
  color: #111;
  text-align: left;
}
  .system { text-align: left; font-style: italic; color: #ff5555; }
  .sender { font-weight: bold; }
  .messageText { display: block; margin-top: 0.25em; }
  #inputArea { display: flex; padding: .5em; background: #111; }
  #prompt { flex: 1; padding: .5em; background: #222; color: #fff; border: 1px solid #444; border-radius: 5px; }
  button { margin-left: .5em; padding: .5em 1em; border: none; border-radius: 5px; background: #6272a4; color: #fff; cursor: pointer; }
  button:hover { background: #7082c4; }
  #clearMemory { background: red; color: white; }
  #historyBtn { background: #ffee8c; color: black; }
  /* Iframe styles */
  #historyFrame { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:95%; height:80%; border:2px solid #50fa7b; background:#111; color:white; overflow-y:auto; z-index:9999; }
  #closeHistory { display:none; position:fixed; top:5%; right:5%; z-index:10000; padding:.5em 1em; border:none; border-radius:5px; background:#ff5555; color:white; cursor:pointer; }
  .highlight { background-color: yellow; color: black; }
  #searchBar {
    padding: 0.5em;
    margin: 0.5em;
    width: 80%;
    border-radius: 5px;
    border: 1px solid #444;
    background: #222;
    color: #fff;
  }
</style>
</head>
<body>
<button id="modsBtn" style="margin-left:10px;">Custom Themes</button>

<div id="modsPanel" style="
  display:none;
  position:fixed;
  top:50%; left:50%;
  transform:translate(-50%,-50%);
  width:400px;
  background:#222;
  color:white;
  border:2px solid #50fa7b;
  border-radius:10px;
  padding:1em;
  z-index:10000;
  box-shadow:0 0 20px #000;
">
  <h3 style="margin-top:0; text-align:center;">Custom Theme Editor</h3>
  <div id="customThemeEditor">
    <label>Background: <input type="color" id="background" class="colorInput" value="#111"></label><br>
    <label>Chat Background: <input type="color" id="chatBackground" class="colorInput" value="#222"></label><br>
    <label>User Bubble: <input type="color" id="userBubble" class="colorInput" value="#6272a4"></label><br>
    <label>AI Bubble: <input type="color" id="aiBubble" class="colorInput" value="#50fa7b"></label><br>
    <label>System Text: <input type="color" id="systemText" class="colorInput" value="#ff5555"></label><br>
    <label>Input Background: <input type="color" id="inputBackground" class="colorInput" value="#222"></label><br>
    <label>Input Text: <input type="color" id="inputText" class="colorInput" value="#ffffff"></label><br><br>
    <button id="applyCustomTheme">Apply</button>
    <button id="saveTheme">Export</button>
    <input type="file" id="loadTheme" accept=".json" style="color:white;" />
  </div>
  <button id="closeMods" style="
    position:absolute; top:8px; right:8px;
    background:red; border:none; color:white;
    border-radius:5px; padding:2px 6px; cursor:pointer;
  ">X</button>
</div>
<input id="searchBar" type="text" placeholder="Search messages..." />
<select id="themeSelector">
  <optgroup label="Classic Themes">
    <option value="dark">Dark</option>
    <option value="light">Light</option>
    <option value="sunset">Sunset</option>
  </optgroup>
  <optgroup label="Color Themes">
    <option value="red">Red</option>
    <option value="orange">Orange</option>
    <option value="yellow">Yellow</option>
    <option value="green">Green</option>
    <option value="teal">Teal</option>
    <option value="blue">Blue</option>
    <option value="purple">Purple</option>
    <option value="pink">Pink</option>
  </optgroup>
</select>

<div id="chat"></div>

<div id="inputArea">
  <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
  <button id="clearMemory">Clear Memory</button>
  <button id="historyBtn">History</button>
</div>

<iframe id="historyFrame"></iframe>
<button id="closeHistory">Close History</button>
<script>
let currentTheme = 'dark';
let customThemes = JSON.parse(localStorage.getItem('customThemes') || '{}');

const baseThemes = {
  dark:{background:'#111',chatBackground:'#222',userBubble:'#6272a4',aiBubble:'#50fa7b',systemText:'#ff5555',inputBackground:'#222',inputText:'#fff'},
  light:{background:'#f4f4f4',chatBackground:'#fff',userBubble:'#007bff',aiBubble:'#28a745',systemText:'#dc3545',inputBackground:'#fff',inputText:'#000'},
  sunset:{background:'#ffecd1',chatBackground:'#ffe4c4',userBubble:'#ff7f50',aiBubble:'#ffa07a',systemText:'#ff4500',inputBackground:'#fff5e6',inputText:'#333'},
  red:{background:'#2b0000',chatBackground:'#3d0c0c',userBubble:'#ff4d4d',aiBubble:'#ff9999',systemText:'#ffb3b3',inputBackground:'#4d0f0f',inputText:'#fff'},
  orange:{background:'#2b1500',chatBackground:'#3d1f00',userBubble:'#ff7b00',aiBubble:'#ffb366',systemText:'#ffcc99',inputBackground:'#4d2600',inputText:'#fff'},
  yellow:{background:'#2b2b00',chatBackground:'#3d3d00',userBubble:'#ffee00',aiBubble:'#fff57f',systemText:'#fff8b3',inputBackground:'#4d4d00',inputText:'#000'},
  green:{background:'#001f00',chatBackground:'#0c3d0c',userBubble:'#00b33c',aiBubble:'#66ff99',systemText:'#aaffcc',inputBackground:'#004d1a',inputText:'#fff'},
  teal:{background:'#001f1f',chatBackground:'#0c3d3d',userBubble:'#00b3b3',aiBubble:'#66ffff',systemText:'#99ffff',inputBackground:'#004d4d',inputText:'#fff'},
  blue:{background:'#000f33',chatBackground:'#001a4d',userBubble:'#3385ff',aiBubble:'#80b3ff',systemText:'#99ccff',inputBackground:'#002b80',inputText:'#fff'},
  purple:{background:'#1a0033',chatBackground:'#26004d',userBubble:'#9933ff',aiBubble:'#cc99ff',systemText:'#e6ccff',inputBackground:'#330066',inputText:'#fff'},
  pink:{background:'#33001a',chatBackground:'#4d0026',userBubble:'#ff66b3',aiBubble:'#ffb3d9',systemText:'#ffccff',inputBackground:'#660033',inputText:'#fff'}
};
const themes = {...baseThemes, ...customThemes};

function applyTheme(name) {
  const theme = themes[name] || baseThemes.dark;
  currentTheme = name;

  document.body.style.transition = 'background 0.4s ease, color 0.4s ease';
  document.getElementById('chat').style.transition = 'background 0.4s ease';
  document.getElementById('prompt').style.transition = 'background 0.4s ease, color 0.4s ease';

  document.body.style.background = theme.background;
  document.getElementById('chat').style.background = theme.chatBackground;
  document.getElementById('prompt').style.background = theme.inputBackground;
  document.getElementById('prompt').style.color = theme.inputText;

  document.querySelectorAll('.user').forEach(el => el.style.background = theme.userBubble);
  document.querySelectorAll('.ai').forEach(el => el.style.background = theme.aiBubble);
  document.querySelectorAll('.system').forEach(el => {
    el.style.color = theme.systemText;
    el.style.textAlign = 'left';
  });

  const typing = document.getElementById('typing');
  if (typing) typing.style.background = theme.aiBubble;
}

function animateMessage(el) {
  el.style.opacity = '0';
  el.style.transform = 'translateY(10px)';
  requestAnimationFrame(() => {
    el.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
    el.style.opacity = '1';
    el.style.transform = 'translateY(0)';
  });
}

function addMessage(sender, text, cls) {
  const chat = document.getElementById('chat');
  const msg = document.createElement('div');
  msg.className = `message ${cls}`;
  msg.innerHTML = `<b>${sender}:</b> <span class="messageText">${text}</span>`;
  chat.appendChild(msg);
  animateMessage(msg);

  const theme = themes[currentTheme];
  if (cls === 'user') msg.style.background = theme.userBubble;
  if (cls === 'ai') msg.style.background = theme.aiBubble;
  if (cls === 'system') {
    msg.style.color = theme.systemText;
    msg.style.textAlign = 'left';
  }

  chat.scrollTop = chat.scrollHeight;
}

function showTyping() {
  if (!document.getElementById('typing')) {
    const t = document.createElement('div');
    t.id = 'typing';
    t.className = 'message ai';
    t.textContent = 'AI is typing...';
    t.style.background = themes[currentTheme].aiBubble;
    t.style.animation = 'pulse 1s infinite';
    document.getElementById('chat').appendChild(t);
  }
}

function hideTyping() {
  const t = document.getElementById('typing');
  if (t) t.remove();
}

async function sendMessage() {
  const prompt = document.getElementById('prompt');
  const text = prompt.value.trim();
  if (!text) return;

  document.querySelectorAll('.system').forEach(el => el.remove());
  addMessage('You', text, 'user');
  prompt.value = '';
  showTyping();

  try {
    const res = await fetch(`/api?input=${encodeURIComponent(text)}`);
    const reply = await res.text();
    hideTyping();
    addMessage('AI', reply, 'ai');
  } catch {
    hideTyping();
    addMessage('System', 'Error connecting to API', 'system');
  }
}

document.getElementById('sendBtn').onclick = sendMessage;
document.getElementById('prompt').addEventListener('keydown', e => {
  if (e.key === 'Enter') sendMessage();
});

document.getElementById('clearMemory').addEventListener('click', async () => {
  await fetch(`/api?clear=true`);
  document.getElementById('chat').innerHTML = '';
  addMessage('System', 'Memory cleared!', 'system');
});

const historyBtn = document.getElementById('historyBtn');
const historyFrame = document.getElementById('historyFrame');
const closeHistory = document.getElementById('closeHistory');
historyBtn.onclick = async () => {
  historyFrame.src = "/api?view=history";
  historyFrame.style.display = 'block';
  closeHistory.style.display = 'block';
};
closeHistory.onclick = () => {
  historyFrame.style.display = 'none';
  closeHistory.style.display = 'none';
};
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    historyFrame.style.display = 'none';
    closeHistory.style.display = 'none';
  }
});

document.getElementById('searchBar').addEventListener('input', e => {
  const term = e.target.value.toLowerCase();
  document.querySelectorAll('#chat .message').forEach(m => {
    const text = m.textContent.toLowerCase();
    m.style.display = term && !text.includes(term) ? 'none' : 'block';
  });
});

document.getElementById('themeSelector').addEventListener('change', e => {
  const val = e.target.value;
  localStorage.setItem('theme', val);
  applyTheme(val);
});

const savedTheme = localStorage.getItem('theme');
if (savedTheme && themes[savedTheme]) {
  applyTheme(savedTheme);
  document.getElementById('themeSelector').value = savedTheme;
} else {
  applyTheme('dark');
}

const style = document.createElement('style');
style.textContent = `
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.6; }
  100% { opacity: 1; }
}
#customThemesMenu {
  display:none; position:fixed; top:50%; left:50%;
  transform:translate(-50%,-50%); background:#111;
  color:white; border:2px solid #50fa7b; padding:1em;
  width:400px; z-index:9999; border-radius:10px;
}
#customThemesMenu h3 { margin-top:0; }
#customThemesMenu ul { list-style:none; padding:0; max-height:200px; overflow:auto; }
#customThemesMenu li { padding:0.5em; display:flex; justify-content:space-between; align-items:center; background:#222; margin-bottom:0.5em; border-radius:5px; }
#customThemesMenu button { border:none; border-radius:5px; padding:0.3em 0.7em; cursor:pointer; }
`;
document.head.appendChild(style);

// ---- Custom Themes Menu ----
const modsBtn = document.getElementById('modsBtn');
const menu = document.createElement('div');
menu.id = 'customThemesMenu';
menu.innerHTML = `
  <h3>Custom Themes</h3>
  <ul id="customThemeList"></ul>
  <input type="file" id="themeUpload" accept=".json" style="margin-top:.5em;">
  <br><br>
  <button id="closeMods" style="background:#ff5555;color:white;">Close</button>
`;
document.body.appendChild(menu);

function refreshCustomThemesList() {
  const list = document.getElementById('customThemeList');
  list.innerHTML = '';
  for (const [name, data] of Object.entries(customThemes)) {
    const li = document.createElement('li');
    li.innerHTML = `<span>${name}</span>
      <div>
        <button class="applyBtn" data-name="${name}" style="background:#50fa7b;">Apply</button>
        <button class="deleteBtn" data-name="${name}" style="background:#ff5555;">Delete</button>
      </div>`;
    list.appendChild(li);
  }
}

modsBtn.onclick = () => {
  refreshCustomThemesList();
  menu.style.display = 'block';
};
document.getElementById('closeMods').onclick = () => {
  menu.style.display = 'none';
};

document.getElementById('themeUpload').addEventListener('change', async e => {
  const file = e.target.files[0];
  if (!file) return;
  const text = await file.text();
  try {
    const themeData = JSON.parse(text);
    if (!themeData.name) throw new Error("Missing 'name'");
    customThemes[themeData.name] = themeData;
    localStorage.setItem('customThemes', JSON.stringify(customThemes));
    const opt = document.createElement('option');
    opt.value = themeData.name;
    opt.textContent = themeData.name + ' (Custom)';
    document.getElementById('themeSelector').appendChild(opt);
    refreshCustomThemesList();
    alert('Theme added!');
  } catch {
    alert('Invalid theme file!');
  }
});

menu.addEventListener('click', e => {
  if (e.target.classList.contains('applyBtn')) {
    const name = e.target.dataset.name;
    applyTheme(name);
    document.getElementById('themeSelector').value = name;
    menu.style.display = 'none';
  } else if (e.target.classList.contains('deleteBtn')) {
    const name = e.target.dataset.name;
    delete customThemes[name];
    localStorage.setItem('customThemes', JSON.stringify(customThemes));
    document.querySelector(`#themeSelector option[value="${name}"]`)?.remove();
    refreshCustomThemesList();
  }
});
</script>
</body>
</html>
