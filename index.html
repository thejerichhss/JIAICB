<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>JIAICB (V0.75)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --transition: 0.35s ease; }
  body { font-family: sans-serif; background: #111; color: #eee; margin: 0; display:flex; flex-direction:column; height:100vh; transition: background var(--transition), color var(--transition); }
  #topbar { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; background:transparent; }
  #chat { flex: 1; padding: 1rem; overflow-y: auto; background: #222; border-top:1px solid #333; border-bottom: 1px solid #333; transition: background var(--transition); }
  .message { display:block; padding:.5rem .8rem; border-radius:14px; margin:.35rem 0; max-width:72%; word-wrap:break-word; position:relative; opacity:0; transform:translateY(10px); transition: opacity .28s ease, transform .28s ease; }
  .user { margin-left:auto; background:#6272a4; color:#fff; text-align:left; }
  .ai { margin-right:auto; background:#50fa7b; color:#111; text-align:left; }
  .system { font-style:italic; color:#ff5555; text-align:left; }
  .message b { display:inline-block; margin-right:.4rem; }
  .messageText { display:block; margin-top:.25rem; }
  #inputArea { display:flex; gap:.5rem; padding:.6rem; align-items:center; background:#111; }
  #prompt { flex:1; padding:.5rem; border-radius:6px; background:#222; color:#fff; border:1px solid #444; transition: background var(--transition), color var(--transition); }
  button { padding:.45rem .8rem; border-radius:6px; border:none; background:#6272a4; color:#fff; cursor:pointer; transition: background .2s; }
  button:hover { filter:brightness(1.05); }
  #clearMemory { background:#d9534f; }
  #historyBtn { background:#ffee8c; color:#111; }
  #modsbtn { background:#50fa7b; color:#111; }
  #searchBar { padding:.45rem; margin:.4rem; width:60%; border-radius:6px; border:1px solid #444; background:#222; color:#fff; }

  /* modal */
  #customThemeModal { display:none; position:fixed; z-index:12000; top:50%; left:50%; transform:translate(-50%,-50%); width:360px; max-width:95%; background:#111; border:2px solid #50fa7b; border-radius:12px; padding:1rem; box-shadow:0 6px 30px rgba(0,0,0,.6); }
  #customThemeModal h3 { margin:0 0 .5rem 0; text-align:center; }
  #customThemeModal label{display:block;margin-top:.35rem;font-size:.9rem}
  #customThemeModal input[type="color"]{width:100%;height:34px;border-radius:6px;border:1px solid #333;padding:0}
  #customThemeList { list-style:none; padding:0; margin: .5rem 0; max-height:150px; overflow:auto; border:1px solid #333; border-radius:6px; padding:.4rem; }
  #customThemeList li { display:flex; justify-content:space-between; align-items:center; padding:.25rem .4rem; margin:.25rem 0; background:#161616; border-radius:6px; }
  #customThemeList button{ margin-left:.4rem; padding:.25rem .5rem; }

  /* iframe history */
  #historyFrame { display:none; position:fixed; z-index:11000; top:50%; left:50%; transform:translate(-50%,-50%); width:92%; height:78%; border:2px solid #50fa7b; background:#111; border-radius:8px; }
  #closeHistory { display:none; position:fixed; z-index:11001; top:6%; right:6%; padding:.5rem .8rem; border-radius:6px; background:#ff5555; color:#fff; }

  /* small screens */
  @media (max-width:600px){
    #searchBar { width:48%; }
    #customThemeModal { width:92%; }
  }
</style>
</head>
<body>
  <div id="topbar">
    <button id="modsbtn">Custom Themes</button>
    <input id="searchBar" placeholder="Search messages..." />
    <select id="themeSelector" aria-label="Select theme">
      <optgroup label="Classic Themes">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="sunset">Sunset</option>
      </optgroup>
      <optgroup label="Color Themes">
        <option value="red">Red</option>
        <option value="orange">Orange</option>
        <option value="yellow">Yellow</option>
        <option value="green">Green</option>
        <option value="teal">Teal</option>
        <option value="blue">Blue</option>
        <option value="purple">Purple</option>
        <option value="pink">Pink</option>
      </optgroup>
    </select>
  </div>

  <div id="chat" aria-live="polite"></div>

  <div id="inputArea">
    <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
    <button id="sendBtn">Send</button>
    <button id="clearMemory">Clear Memory</button>
    <button id="historyBtn">History</button>
    <button id="exportChatBtn" style="background:#00bfff;color:#fff;">Export Chat</button>
    <button id="importChatBtn" style="background:#50fa7b;color:#111;">Import Chat</button>
    <input id="importChatFile" type="file" accept="application/json" style="display:none">
  </div>

  <iframe id="historyFrame" title="Chat History"></iframe>
  <button id="closeHistory">Close History</button>

  <!-- Custom Theme Modal (hidden initially) -->
  <div id="customThemeModal" role="dialog" aria-hidden="true">
    <h3>Custom Theme Creator</h3>

    <label>Background</label>
    <input id="bgColor" type="color" value="#111">

    <label>Chat Background</label>
    <input id="chatBgColor" type="color" value="#222">

    <label>User Bubble</label>
    <input id="userColor" type="color" value="#6272a4">

    <label>AI Bubble</label>
    <input id="aiColor" type="color" value="#50fa7b">

    <label>System Text</label>
    <input id="systemColor" type="color" value="#ff5555">

    <h4 style="margin:.5rem 0 0 0">Saved Themes</h4>
    <ul id="customThemeList"></ul>

    <div style="display:flex; gap:.5rem; margin-top:.6rem; justify-content:center;">
      <button id="previewTheme">Preview</button>
      <button id="saveTheme">Save</button>
      <button id="exportThemeBtn" style="background:#00bfff;color:#fff;">Export Theme</button>
      <button id="importThemeBtn" style="background:#50fa7b;color:#111;">Import Theme</button>
      <input id="importThemeFile" type="file" accept="application/json" style="display:none;">
      <button id="closeTheme" style="background:#ff5555;color:#fff;">Close</button>
    </div>
  </div>

<script>
/* ---------- State & Elements ---------- */
// Generate or load a unique device ID (acts like private IP memory)
if (!localStorage.getItem("deviceId")) {
  localStorage.setItem("deviceId", crypto.randomUUID());
}
const deviceId = localStorage.getItem("deviceId");
console.log("Device ID:", deviceId);

const chat = document.getElementById('chat');
const promptEl = document.getElementById('prompt');
const sendBtn = document.getElementById('sendBtn');
const clearMemoryBtn = document.getElementById('clearMemory');
const historyBtn = document.getElementById('historyBtn');
const historyFrame = document.getElementById('historyFrame');
const closeHistory = document.getElementById('closeHistory');
const themeSelector = document.getElementById('themeSelector');

const modsbtn = document.getElementById('modsbtn');
const modal = document.getElementById('customThemeModal');
const previewThemeBtn = document.getElementById('previewTheme');
const saveThemeBtn = document.getElementById('saveTheme');
const exportThemeBtn = document.getElementById('exportThemeBtn');
const importThemeBtn = document.getElementById('importThemeBtn');
const importThemeFile = document.getElementById('importThemeFile');
const closeTheme = document.getElementById('closeTheme');
const customThemeList = document.getElementById('customThemeList');

const importChatBtn = document.getElementById('importChatBtn');
const importChatFile = document.getElementById('importChatFile');
const exportChatBtn = document.getElementById('exportChatBtn');
const inputArea = document.getElementById('inputArea');

let customThemes = JSON.parse(localStorage.getItem('customThemes') || '{}');
let chatHistory = JSON.parse(localStorage.getItem('chatHistory') || '[]');
let currentTheme = localStorage.getItem('theme') || 'dark';
let loadedSavedChat = false;

/* ---------- Themes Definition ---------- */
const baseThemes = {
  dark:{background:'#111',chatBackground:'#222',userBubble:'#6272a4',aiBubble:'#50fa7b',systemText:'#ff5555',inputBackground:'#222',inputText:'#fff'},
  light:{background:'#f4f4f4',chatBackground:'#fff',userBubble:'#007bff',aiBubble:'#28a745',systemText:'#dc3545',inputBackground:'#fff',inputText:'#000'},
  sunset:{background:'#ffecd1',chatBackground:'#ffe4c4',userBubble:'#ff7f50',aiBubble:'#ffa07a',systemText:'#ff4500',inputBackground:'#fff5e6',inputText:'#333'}
};
const colorThemes = {
  red:{background:'#2b0000',chatBackground:'#3d0c0c',userBubble:'#ff4d4d',aiBubble:'#ff9999',systemText:'#ffb3b3',inputBackground:'#4d0f0f',inputText:'#fff'},
  orange:{background:'#2b1500',chatBackground:'#3d1f00',userBubble:'#ff7b00',aiBubble:'#ffb366',systemText:'#ffcc99',inputBackground:'#4d2600',inputText:'#fff'},
  yellow:{background:'#2b2b00',chatBackground:'#3d3d00',userBubble:'#ffee00',aiBubble:'#fff57f',systemText:'#fff8b3',inputBackground:'#4d4d00',inputText:'#000'},
  green:{background:'#001f00',chatBackground:'#0c3d0c',userBubble:'#00b33c',aiBubble:'#66ff99',systemText:'#aaffcc',inputBackground:'#004d1a',inputText:'#fff'},
  teal:{background:'#001f1f',chatBackground:'#0c3d3d',userBubble:'#00b3b3',aiBubble:'#66ffff',systemText:'#99ffff',inputBackground:'#004d4d',inputText:'#fff'},
  blue:{background:'#000f33',chatBackground:'#001a4d',userBubble:'#3385ff',aiBubble:'#80b3ff',systemText:'#99ccff',inputBackground:'#002b80',inputText:'#fff'},
  purple:{background:'#1a0033',chatBackground:'#26004d',userBubble:'#9933ff',aiBubble:'#cc99ff',systemText:'#e6ccff',inputBackground:'#330066',inputText:'#fff'},
  pink:{background:'#33001a',chatBackground:'#4d0026',userBubble:'#ff66b3',aiBubble:'#ffb3d9',systemText:'#ffccff',inputBackground:'#660033',inputText:'#fff'}
};

function getAllThemes(){ return {...baseThemes, ...colorThemes, ...customThemes}; }

/* ---------- Apply Theme ---------- */
function applyTheme(name, overrideTheme){
  const themes = getAllThemes();
  const theme = overrideTheme || customThemes[name] || themes[name] || baseThemes.dark;
  currentTheme = name;
  localStorage.setItem('theme', name);

  document.body.style.background = theme.background;
  document.body.style.color = theme.inputText || '#eee';
  if(chat) chat.style.background = theme.chatBackground;
  if(promptEl){ promptEl.style.background = theme.inputBackground; promptEl.style.color = theme.inputText; }

  document.querySelectorAll('.user').forEach(el => el.style.background = theme.userBubble);
  document.querySelectorAll('.ai').forEach(el => el.style.background = theme.aiBubble);
  document.querySelectorAll('.system').forEach(el => el.style.color = theme.systemText);

  const typing = document.getElementById('typing');
  if(typing) typing.style.background = theme.aiBubble;
}

/* ---------- Message Add & Animation ---------- */
function animateIn(el){
  el.style.opacity = '0';
  el.style.transform = 'translateY(10px)';
  requestAnimationFrame(()=> {
    el.style.transition = 'opacity .28s ease, transform .28s ease';
    el.style.opacity = '1';
    el.style.transform = 'translateY(0)';
  });
}
function smoothScrollToBottom() {
  chat.scrollTo({
    top: chat.scrollHeight,
    behavior: 'smooth'
  });
}

function addMessage(sender, text, cls, options = { save: true }) {
  const dateKey = new Date().toLocaleDateString();
  let section = chat.querySelector(`.chat-section[data-date="${dateKey}"]`);
  if(!section) {
    section = document.createElement('div');
    section.className = 'chat-section';
    section.dataset.date = dateKey;
    section.innerHTML = `
      <div class="section-header" style="cursor:pointer; font-weight:bold; margin-top:1rem; background:#333; padding:.3rem .6rem; border-radius:6px;">
        ${dateKey} ▼
      </div>
      <div class="section-content"></div>
    `;
    chat.appendChild(section);

    // toggle collapse
    const header = section.querySelector('.section-header');
    const content = section.querySelector('.section-content');
    header.addEventListener('click', ()=>{
      const visible = content.style.display !== 'none';
      content.style.display = visible ? 'none' : 'block';
      header.textContent = `${dateKey} ${visible ? '►' : '▼'}`;
    });
  }

  const content = section.querySelector('.section-content');

  const msg = document.createElement('div');
  msg.className = `message ${cls}`;
  msg.innerHTML = `<b>${sender}:</b> <span class="messageText">${text}</span>`;

  const theme = getAllThemes()[currentTheme] || baseThemes.dark;
  if(cls==='user') msg.style.background = theme.userBubble;
  if(cls==='ai') msg.style.background = theme.aiBubble;
  if(cls==='system'){ msg.style.color = theme.systemText; msg.style.textAlign = 'left'; }

  content.appendChild(msg);
  animateIn(msg);
  smoothScrollToBottom();

  if(options.save){
    chatHistory.push({ sender, text, cls });
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  }
}

/* ---------- Typing Indicator ---------- */
function showTyping(){
  if(document.getElementById('typing')) return;
  const t = document.createElement('div');
  t.id='typing';
  t.className = 'message ai';
  t.textContent = 'AI is typing...';
  t.style.background = (getAllThemes()[currentTheme] || baseThemes.dark).aiBubble;
  chat.appendChild(t);
  smoothScrollToBottom();
}
function hideTyping(){ const t=document.getElementById('typing'); if(t) t.remove(); }

/* ---------- Send message ---------- */
async function sendMessage(){
  const text = (promptEl && promptEl.value || '').trim();
  if(!text) return;
  addMessage('You', text, 'user');
  if(promptEl) promptEl.value = '';
  showTyping();
  try{
    const res = await fetch(`https://jiaicb.onrender.com/api?input=${encodeURIComponent(text)}&device=${deviceId}`);
    const reply = await res.text();
    hideTyping();
    addMessage('AI', reply, 'ai');
  }catch(err){
    hideTyping();
    addMessage('System', 'Error contacting API.', 'system');
  }
}

/* ---------- Load saved chat (once) ---------- */
function loadSavedChatOnce(){
  if(loadedSavedChat) return;
  loadedSavedChat = true;
  if(!chatHistory || !chatHistory.length) return;
  // render saved chat WITHOUT saving again (so no duplicates)
  chatHistory.forEach(m => addMessage(m.sender, m.text, m.cls, { save: false }));
}
loadSavedChatOnce();

/* ---------- Wire UI Actions ---------- */
if(sendBtn) sendBtn.addEventListener('click', sendMessage);
if(promptEl) promptEl.addEventListener('keydown', e => { if(e.key==='Enter') sendMessage(); });

if(clearMemoryBtn) clearMemoryBtn.addEventListener('click', async ()=>{
  if(!confirm('Clear local chat memory and server memory?')) return;
  try{ await fetch(`/api?clear=true&device=${deviceId}`); }catch(e){}
  chat.innerHTML = '';
  chatHistory = [];
  localStorage.removeItem('chatHistory');
  addMessage('System','Memory cleared!','system', { save: false });
});

if(historyBtn) historyBtn.addEventListener('click', ()=>{
  historyFrame.src = '/api?view=history&' + Date.now();
  historyFrame.style.display = 'block';
  closeHistory.style.display = 'block';
});
if(closeHistory) closeHistory.addEventListener('click', ()=>{
  historyFrame.style.display = 'none';
  closeHistory.style.display = 'none';
});

/* ---------- Theme selector wiring ---------- */
if(themeSelector){
  // add any custom theme options (avoid duplicates)
  function refreshThemeSelector(){
    // remove previously injected custom options
    [...themeSelector.querySelectorAll('option')].forEach(opt=>{
      if(opt.dataset.custom === 'true') opt.remove();
    });
    for(const name of Object.keys(customThemes)){
      const opt = document.createElement('option');
      opt.value = name;
      opt.textContent = name + ' (Custom)';
      opt.dataset.custom='true';
      themeSelector.appendChild(opt);
    }
  }
  refreshThemeSelector();
  themeSelector.value = currentTheme;
  themeSelector.addEventListener('change', e => { applyTheme(e.target.value); });
}
applyTheme(currentTheme);

/* ---------- Custom Themes Modal ---------- */
function refreshCustomThemeList(){
  customThemeList.innerHTML = '';
  for(const [name, t] of Object.entries(customThemes)){
    const li = document.createElement('li');
    li.innerHTML = `<span>${name}</span><div>
      <button class="applyBtn" data-name="${name}" style="margin-right:6px">Apply</button>
      <button class="deleteBtn" data-name="${name}">Delete</button>
    </div>`;
    customThemeList.appendChild(li);
  }
}
if(modsbtn) modsbtn.addEventListener('click', ()=> {
  if(!modal) return alert('Theme modal missing');
  modal.style.display = 'block';
  refreshCustomThemeList();
});
if(closeTheme) closeTheme.addEventListener('click', ()=> modal.style.display = 'none');

if(previewThemeBtn) previewThemeBtn.addEventListener('click', ()=>{
  const theme = {
    background: bgColor.value,
    chatBackground: chatBgColor.value,
    userBubble: userColor.value,
    aiBubble: aiColor.value,
    systemText: systemColor.value,
    inputBackground: "#222",
    inputText: "#fff"
  };
  applyTheme('custom', theme);
});

if(saveThemeBtn) saveThemeBtn.addEventListener('click', ()=>{
  const name = "Custom_" + Date.now();
  const theme = {
    background: bgColor.value,
    chatBackground: chatBgColor.value,
    userBubble: userColor.value,
    aiBubble: aiColor.value,
    systemText: systemColor.value,
    inputBackground: "#222",
    inputText: "#fff"
  };
  customThemes[name] = theme;
  localStorage.setItem('customThemes', JSON.stringify(customThemes));
  // add to selector
  const opt = document.createElement('option'); opt.value = name; opt.textContent = name + ' (Custom)'; opt.dataset.custom='true';
  if(themeSelector) themeSelector.appendChild(opt);
  refreshCustomThemeList();
  applyTheme(name, theme);
  modal.style.display = 'none';
});

if(importThemeBtn && importThemeFile) {
  importThemeBtn.addEventListener('click', ()=> importThemeFile.click());
  importThemeFile.addEventListener('change', async e => {
    const file = e.target.files[0]; if(!file) return;
    try{
      const txt = await file.text();
      const t = JSON.parse(txt);
      // If file is a map of themes, merge; if single theme object with name, import under name
      if(t && typeof t === 'object'){
        if(t.name && t.userBubble){ // single theme
          customThemes[t.name] = t;
        } else {
          // merge assume object of name->theme
          Object.assign(customThemes, t);
        }
        localStorage.setItem('customThemes', JSON.stringify(customThemes));
        refreshCustomThemeList();
        // update selector
        if(themeSelector){
          for(const name of Object.keys(customThemes)){
            if(!themeSelector.querySelector(`option[value="${name}"]`)){
              const opt = document.createElement('option'); opt.value = name; opt.textContent = name + ' (Custom)'; opt.dataset.custom='true';
              themeSelector.appendChild(opt);
            }
          }
        }
        alert('Theme(s) imported.');
      } else throw new Error('Bad theme file');
    }catch(err){ alert('Invalid theme file.'); }
    e.target.value = '';
  });
}

if(exportThemeBtn) exportThemeBtn.addEventListener('click', ()=>{
  const sample = {
    name: "CustomTheme_" + Date.now(),
    background: bgColor.value,
    chatBackground: chatBgColor.value,
    userBubble: userColor.value,
    aiBubble: aiColor.value,
    systemText: systemColor.value,
    inputBackground: "#222",
    inputText: "#fff"
  };
  const blob = new Blob([JSON.stringify(sample, null, 2)], { type: 'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = sample.name + '.json'; a.click();
  URL.revokeObjectURL(a.href);
});

/* apply/delete buttons inside modal list */
if(customThemeList) customThemeList.addEventListener('click', e=>{
  if(e.target.classList.contains('applyBtn')){
    const name = e.target.dataset.name;
    applyTheme(name);
    if(themeSelector) themeSelector.value = name;
  } else if(e.target.classList.contains('deleteBtn')){
    const name = e.target.dataset.name;
    delete customThemes[name];
    localStorage.setItem('customThemes', JSON.stringify(customThemes));
    const opt = themeSelector.querySelector(`option[value="${name}"]`);
    if(opt) opt.remove();
    refreshCustomThemeList();
  }
});

/* ---------- Export Chat ---------- */
if(exportChatBtn){
  exportChatBtn.addEventListener('click', ()=>{
    const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: 'application/json' });
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'chat_history.json'; a.click();
    URL.revokeObjectURL(a.href);
  });
}

/* ---------- Import Chat (replace memory) ---------- */
if(importChatBtn && importChatFile){
  importChatBtn.addEventListener('click', ()=> importChatFile.click());
  importChatFile.addEventListener('change', async e => {
    const file = e.target.files[0]; if(!file) return;
    const proceed = confirm('⚠️ Import will REPLACE current conversation memory. Continue?');
    if(!proceed){ e.target.value = ''; return; }
    try{
      const txt = await file.text();
      const imported = JSON.parse(txt);
      // validate array
      if(!Array.isArray(imported)) throw new Error('Imported chat must be an array of messages');

      // clear UI and memory
      chat.innerHTML = '';
      chatHistory = [];
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

      // add imported messages and save them to local storage
      imported.forEach(m => {
        // guard: ensure fields
        const sender = m.sender || (m.cls === 'user' ? 'You' : (m.cls === 'ai' ? 'AI' : 'System'));
        const text = (m.text === undefined) ? '' : String(m.text);
        const cls = m.cls || (sender === 'You' ? 'user' : sender === 'AI' ? 'ai' : 'system');
        addMessage(sender, text, cls, { save: true });
      });

      // persist
      localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

      // attempt backend sync via POST /api (server must support)
      try{
        await fetch('/api', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ memory: chatHistory })
        });
      }catch(err){
        console.warn('Backend sync failed (optional):', err);
      }

      addMessage('System', 'Chat imported successfully!', 'system', { save: false });
      // update history iframe if open
      if(historyFrame) historyFrame.src = '/api?view=history&' + Date.now();
    }catch(err){
      console.error(err);
      alert('Invalid chat file. It must be JSON array of messages.');
    } finally {
      e.target.value = '';
    }
  });
}

/* ---------- Reapply theme to any preloaded messages & load saved chat ---------- */
(function init(){
  // apply theme colors to any messages that might already be in DOM
  applyTheme(currentTheme);

  // If there are messages in chatHistory and nothing rendered, render them (no duplicates)
  // Use a tiny delay to ensure DOM is ready
  setTimeout(()=> {
    // If chat already has children (e.g., server injected) don't re-add saved chat to avoid duplication
    if(chat.children.length === 0 && chatHistory && chatHistory.length){
      chatHistory.forEach(m => addMessage(m.sender, m.text, m.cls, { save: false }));
    }
  }, 10);
})();
document.getElementById("historyBtn").addEventListener("click", () => {
  const iframe = document.createElement("iframe");
  iframe.src = "/history";
  iframe.style.width = "100%";
  iframe.style.height = "500px";
  iframe.style.border = "2px solid #444";
  iframe.style.borderRadius = "10px";
  iframe.style.background = "#111";
  iframe.style.marginTop = "10px";

  // remove any previous iframe before adding a new one
  document.querySelectorAll("iframe").forEach(i => i.remove());
  document.body.appendChild(iframe);
});
</script>
</body>
</html>
