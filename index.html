<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>JIAICB (V0.73)</title>
<style>
  body { font-family: sans-serif; background: #111; color: #eee; margin: 0; display: flex; flex-direction: column; height: 100vh; transition: background 0.4s, color 0.4s; }
  #chat { flex: 1; padding: 1em; overflow-y: auto; background: #222; border-bottom: 1px solid #333; text-align: left; transition: background 0.4s; }
  .message { display: block; padding: 0.5em 1em; border-radius: 15px; margin: 0.25em 0; max-width: 70%; word-wrap: break-word; position: relative; opacity:0; transform: translateY(10px); transition: opacity 0.3s, transform 0.3s; }
  .user { align-self: flex-end; background: #6272a4; color: #fff; text-align: left; }
  .ai { align-self: flex-start; background: #50fa7b; color: #111; text-align: left; }
  .system { text-align: left; font-style: italic; color: #ff5555; }
  .messageText { display: block; margin-top: 0.25em; }
  #inputArea { display: flex; padding: .5em; background: #111; }
  #prompt { flex: 1; padding: .5em; background: #222; color: #fff; border: 1px solid #444; border-radius: 5px; transition: background 0.4s, color 0.4s; }
  button { margin-left: .5em; padding: .5em 1em; border: none; border-radius: 5px; background: #6272a4; color: #fff; cursor: pointer; transition: background 0.3s; }
  button:hover { background: #7082c4; }
  #clearMemory { background: red; color: white; }
  #historyBtn { background: #ffee8c; color: black; }
  #historyFrame { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:95%; height:80%; border:2px solid #50fa7b; background:#111; color:white; overflow-y:auto; z-index:9999; }
  #closeHistory { display:none; position:fixed; top:5%; right:5%; z-index:10000; padding:.5em 1em; border:none; border-radius:5px; background:#ff5555; color:white; cursor:pointer; }
  #searchBar { padding: 0.5em; margin: 0.5em; width: 80%; border-radius: 5px; border: 1px solid #444; background: #222; color: #fff; }
  /* Custom Theme Modal */
  #customThemeModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
    background:#111; color:#fff; border:2px solid #50fa7b; border-radius:15px;
    padding:1em; z-index:10000; width:350px; max-height:80%; overflow-y:auto; box-shadow:0 0 20px #50fa7b;
  }
</style>
</head>
<body>

<button id="modsbtn" style="margin-left:10px;">Custom Themes</button>

<!-- Custom Theme Modal -->
<div id="customThemeModal">
  <h3 style="text-align:center;">V1.0 Custom Theme Creator</h3>
  <label>Background:</label><input type="color" id="bgColor" value="#111"><br><br>
  <label>Chat Background:</label><input type="color" id="chatBgColor" value="#222"><br><br>
  <label>User Bubble:</label><input type="color" id="userColor" value="#6272a4"><br><br>
  <label>AI Bubble:</label><input type="color" id="aiColor" value="#50fa7b"><br><br>
  <label>System Text:</label><input type="color" id="systemColor" value="#ff5555"><br><br>

  <h4>Saved Themes</h4>
  <ul id="customThemeList" style="list-style:none; padding:5px; max-height:150px; overflow-y:auto; border:1px solid #444; border-radius:5px;"></ul>

  <div style="text-align:center; margin-top:10px;">
    <button id="previewTheme">Preview</button>
    <button id="saveTheme">Save</button>
    <button id="exportThemeBtn" style="background:#00bfff;color:white;margin-top:5px;">Export Theme</button>
    <button id="importThemeBtn" style="background:#50fa7b;color:white;margin-top:5px;">Import Theme</button>
    <input type="file" id="importThemeFile" accept=".json" style="display:none;">
    <button id="closeTheme" style="background:#ff5555;color:white;">Close</button>
  </div>
</div>

<input id="searchBar" type="text" placeholder="Search messages..." />
<select id="themeSelector">
  <optgroup label="Classic Themes">
    <option value="dark">Dark</option>
    <option value="light">Light</option>
    <option value="sunset">Sunset</option>
  </optgroup>
  <optgroup label="Color Themes">
    <option value="red">Red</option>
    <option value="orange">Orange</option>
    <option value="yellow">Yellow</option>
    <option value="green">Green</option>
    <option value="teal">Teal</option>
    <option value="blue">Blue</option>
    <option value="purple">Purple</option>
    <option value="pink">Pink</option>
  </optgroup>
</select>

<div id="chat"></div>

<div id="inputArea">
  <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
  <button id="sendBtn">Send</button>
  <button id="clearMemory">Clear Memory</button>
  <button id="historyBtn">History</button>
  <button id="importChatBtn" style="background:#50fa7b;color:#111;">Import Chat</button>
  <input type="file" id="importChatFile" accept=".json" style="display:none;">
</div>

<iframe id="historyFrame"></iframe>
<button id="closeHistory">Close History</button>
<script>
let currentTheme = localStorage.getItem('theme') || 'dark';
let chatHistory = [];

/* --- THEME DEFINITIONS --- */
const baseThemes = {
  dark:{background:'#111',chatBackground:'#222',userBubble:'#6272a4',aiBubble:'#50fa7b',systemText:'#ff5555',inputBackground:'#222',inputText:'#fff'},
  light:{background:'#f4f4f4',chatBackground:'#fff',userBubble:'#007bff',aiBubble:'#28a745',systemText:'#dc3545',inputBackground:'#fff',inputText:'#000'},
  sunset:{background:'#ffecd1',chatBackground:'#ffe4c4',userBubble:'#ff7f50',aiBubble:'#ffa07a',systemText:'#ff4500',inputBackground:'#fff5e6',inputText:'#333'}
};
const colorThemes = {
  red:{background:'#2b0000',chatBackground:'#3d0c0c',userBubble:'#ff4d4d',aiBubble:'#ff9999',systemText:'#ffb3b3',inputBackground:'#4d0f0f',inputText:'#fff'},
  orange:{background:'#2b1500',chatBackground:'#3d1f00',userBubble:'#ff7b00',aiBubble:'#ffb366',systemText:'#ffcc99',inputBackground:'#4d2600',inputText:'#fff'},
  yellow:{background:'#2b2b00',chatBackground:'#3d3d00',userBubble:'#ffee00',aiBubble:'#fff57f',systemText:'#fff8b3',inputBackground:'#4d4d00',inputText:'#000'},
  green:{background:'#001f00',chatBackground:'#0c3d0c',userBubble:'#00b33c',aiBubble:'#66ff99',systemText:'#aaffcc',inputBackground:'#004d1a',inputText:'#fff'},
  teal:{background:'#001f1f',chatBackground:'#0c3d3d',userBubble:'#00b3b3',aiBubble:'#66ffff',systemText:'#99ffff',inputBackground:'#004d4d',inputText:'#fff'},
  blue:{background:'#000f33',chatBackground:'#001a4d',userBubble:'#3385ff',aiBubble:'#80b3ff',systemText:'#99ccff',inputBackground:'#002b80',inputText:'#fff'},
  purple:{background:'#1a0033',chatBackground:'#26004d',userBubble:'#9933ff',aiBubble:'#cc99ff',systemText:'#e6ccff',inputBackground:'#330066',inputText:'#fff'},
  pink:{background:'#33001a',chatBackground:'#4d0026',userBubble:'#ff66b3',aiBubble:'#ffb3d9',systemText:'#ffccff',inputBackground:'#660033',inputText:'#fff'}
};
const themes = { ...baseThemes, ...colorThemes };

/* --- APPLY THEME FUNCTION --- */
function applyTheme(name){
  const t = themes[name] || themes.dark;
  currentTheme = name;
  localStorage.setItem('theme', name);

  document.body.style.background = t.background;
  document.body.style.color = t.inputText;

  const chat = document.getElementById('chat');
  if(chat) chat.style.background = t.chatBackground;

  const prompt = document.getElementById('prompt');
  if(prompt){
    prompt.style.background = t.inputBackground;
    prompt.style.color = t.inputText;
  }

  // Update all existing bubbles
  document.querySelectorAll('.user').forEach(el => el.style.background = t.userBubble);
  document.querySelectorAll('.ai').forEach(el => el.style.background = t.aiBubble);
  document.querySelectorAll('.system').forEach(el => el.style.color = t.systemText);

  // Typing indicator
  const typing = document.getElementById('typing');
  if(typing) typing.style.background = t.aiBubble;
}

/* --- LOAD SAVED THEME --- */
applyTheme(currentTheme);

/* --- THEME SELECTOR --- */
document.getElementById('themeSelector').addEventListener('change', e=>{
  applyTheme(e.target.value);
});

/* --- ADD MESSAGE --- */
function addMessage(sender, text, cls, options={save:true}){
  const chat = document.getElementById('chat');
  const msg = document.createElement('div');
  msg.className = `message ${cls}`;
  msg.innerHTML = `<b>${sender}:</b> <span class="messageText">${text}</span>`;

  const t = themes[currentTheme];
  if(cls==='user') msg.style.background = t.userBubble;
  if(cls==='ai') msg.style.background = t.aiBubble;
  if(cls==='system') msg.style.color = t.systemText;

  msg.style.opacity = '0';
  msg.style.transform = 'translateY(10px)';
  chat.appendChild(msg);
  requestAnimationFrame(()=>{
    msg.style.transition = 'opacity .3s, transform .3s';
    msg.style.opacity = '1';
    msg.style.transform = 'translateY(0)';
  });
  chat.scrollTop = chat.scrollHeight;

  if(options.save){
    chatHistory.push({sender,text,cls});
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
  }
}

/* --- TYPING INDICATOR --- */
function showTyping(){
  if(!document.getElementById('typing')){
    const t = document.createElement('div');
    t.id = 'typing';
    t.className = 'message ai';
    t.textContent = 'AI is typing...';
    t.style.background = themes[currentTheme].aiBubble;
    document.getElementById('chat').appendChild(t);
  }
}
function hideTyping(){ const t=document.getElementById('typing'); if(t) t.remove(); }

/* --- SEND MESSAGE --- */
async function sendMessage(){
  const prompt=document.getElementById('prompt');
  const text=prompt.value.trim();
  if(!text)return;
  addMessage('You',text,'user');
  prompt.value='';
  showTyping();
  try{
    const res=await fetch(`/api?input=${encodeURIComponent(text)}`);
    const reply=await res.text();
    hideTyping();
    addMessage('AI',reply,'ai');
  }catch{
    hideTyping();
    addMessage('System','Error contacting API.','system');
  }
}
document.getElementById('sendBtn').onclick=sendMessage;
document.getElementById('prompt').addEventListener('keydown',e=>{if(e.key==='Enter')sendMessage();});

/* --- CLEAR MEMORY --- */
document.getElementById('clearMemory').addEventListener('click', async()=>{
  await fetch('/api?clear=true');
  document.getElementById('chat').innerHTML='';
  chatHistory=[];
  localStorage.removeItem('chatHistory');
  addMessage('System','Memory cleared!','system',{save:false});
});

/* --- HISTORY (iframe view of /api?view=history) --- */
const historyBtn=document.getElementById('historyBtn');
const historyFrame=document.getElementById('historyFrame');
const closeHistory=document.getElementById('closeHistory');
historyBtn.onclick=()=>{
  historyFrame.src='/api?view=history';
  historyFrame.style.display='block';
  closeHistory.style.display='block';
};
closeHistory.onclick=()=>{
  historyFrame.style.display='none';
  closeHistory.style.display='none';
};

// --- EXPORT CHAT ---
const exportBtn = document.createElement('button');
exportBtn.textContent = 'Export Chat';
exportBtn.style.background = '#00bfff';
exportBtn.style.color = '#fff';
exportBtn.style.marginLeft = '.5em';
exportBtn.onclick = () => {
  const blob = new Blob([JSON.stringify(chatHistory, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'chat_history.json';
  a.click();
  URL.revokeObjectURL(url);
};
document.getElementById('inputArea').appendChild(exportBtn);

/* --- Mods Button --- */
modsBtn.addEventListener("click", () => {
  const modal = document.createElement("div");
  modal.className =
    "fixed inset-0 flex items-center justify-center bg-black bg-opacity-60 z-50";
  modal.innerHTML = `
    <div class="bg-white dark:bg-gray-800 p-6 rounded-2xl shadow-2xl max-w-md w-full text-gray-900 dark:text-white transition-all duration-300">
      <h2 class="text-xl font-bold mb-4 text-center">Create Custom Theme</h2>
      <label class="block mb-2">Theme Name:</label>
      <input id="themeName" class="w-full mb-3 p-2 rounded bg-gray-100 dark:bg-gray-700" placeholder="MyTheme" />
      <label class="block mb-2">Background:</label>
      <input type="color" id="bgColor" class="w-full mb-3">
      <label class="block mb-2">Text Color:</label>
      <input type="color" id="textColor" class="w-full mb-3">
      <label class="block mb-2">User Bubble:</label>
      <input type="color" id="userColor" class="w-full mb-3">
      <label class="block mb-2">AI Bubble:</label>
      <input type="color" id="aiColor" class="w-full mb-4">
      <div class="flex justify-between">
        <button id="previewTheme" class="px-3 py-2 bg-blue-600 text-white rounded">Preview</button>
        <button id="saveTheme" class="px-3 py-2 bg-green-600 text-white rounded">Save</button>
        <button id="cancelTheme" class="px-3 py-2 bg-gray-500 text-white rounded">Cancel</button>
      </div>
    </div>
  `;
  document.body.appendChild(modal);

  modal.querySelector("#cancelTheme").onclick = () => modal.remove();

  modal.querySelector("#previewTheme").onclick = () => {
    const colors = getThemeInputs();
    Object.entries(colors).forEach(([k, v]) =>
      document.documentElement.style.setProperty(k, v)
    );
  };

  modal.querySelector("#saveTheme").onclick = () => {
    const name = modal.querySelector("#themeName").value.trim() || "Custom";
    const colors = getThemeInputs();
    const customThemes = JSON.parse(localStorage.getItem("customThemes") || "[]");
    customThemes.push({ name, colors });
    localStorage.setItem("customThemes", JSON.stringify(customThemes));
    modal.remove();
    location.reload();
  };

  function getThemeInputs() {
    return {
      "--bg": modal.querySelector("#bgColor").value,
      "--text": modal.querySelector("#textColor").value,
      "--user-bubble": modal.querySelector("#userColor").value,
      "--ai-bubble": modal.querySelector("#aiColor").value
    };
  }
});

// --- IMPORT CHAT ---
const importChatBtn = document.getElementById('importChatBtn');
const importChatFile = document.getElementById('importChatFile');

importChatBtn.addEventListener('click', () => importChatFile.click());

importChatFile.addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  try {
    const text = await file.text();
    const importedChat = JSON.parse(text);

    // Clear current chat + memory
    document.getElementById('chat').innerHTML = '';
    chatHistory = [];

    // Add imported messages & save to memory
    importedChat.forEach(msg => {
      addMessage(msg.sender, msg.text, msg.cls, { save: true });
    });

    // Persist in localStorage
    localStorage.setItem('chatHistory', JSON.stringify(chatHistory));

    // Optional backend sync (skip if not needed)
    try {
      await fetch('/api', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ memory: chatHistory })
      });
    } catch (err) {
      console.warn('Backend sync skipped');
    }

    addMessage('System', 'Chat imported successfully!', 'system', { save: false });

  } catch (err) {
    console.error('Import failed:', err);
    alert('Invalid or unreadable chat file!');
  }

  // Reset file input so it can be used again
  e.target.value = '';
});
</script>
</body>
</html>
