<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>JIAICB (V0.75)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --transition: 0.35s ease; }
  body { font-family: sans-serif; background: #111; color: #eee; margin: 0; display:flex; flex-direction:column; height:100vh; transition: background var(--transition), color var(--transition); }
  #topbar { display:flex; align-items:center; gap:0.5rem; padding:0.5rem; background:transparent; }
  #chat { flex: 1; padding: 1rem; overflow-y: auto; background: #222; border-top:1px solid #333; border-bottom: 1px solid #333; transition: background var(--transition); }
  .message { display:block; padding:.5rem .8rem; border-radius:14px; margin:.35rem 0; max-width:72%; word-wrap:break-word; position:relative; opacity:0; transform:translateY(10px); transition: opacity .28s ease, transform .28s ease; }
  .user { margin-left:auto; background:#6272a4; color:#fff; text-align:left; }
  .ai { margin-right:auto; background:#50fa7b; color:#111; text-align:left; }
  .system { font-style:italic; color:#ff5555; text-align:left; }
  .message b { display:inline-block; margin-right:.4rem; }
  .messageText { display:block; margin-top:.25rem; }
  #inputArea { display:flex; gap:.5rem; padding:.6rem; align-items:center; background:#111; }
  #prompt { flex:1; padding:.5rem; border-radius:6px; background:#222; color:#fff; border:1px solid #444; transition: background var(--transition), color var(--transition); }
  button { padding:.45rem .8rem; border-radius:6px; border:none; background:#6272a4; color:#fff; cursor:pointer; transition: background .2s; }
  button:hover { filter:brightness(1.05); }
  #clearMemory { background:#d9534f; }
  #historyBtn { background:#ffee8c; color:#111; }
  #modsbtn { background:#50fa7b; color:#111; }
  #searchBar { padding:.45rem; margin:.4rem; width:60%; border-radius:6px; border:1px solid #444; background:#222; color:#fff; }

  /* modal */
  #customThemeModal { display:none; position:fixed; z-index:12000; top:50%; left:50%; transform:translate(-50%,-50%); width:360px; max-width:95%; background:#111; border:2px solid #50fa7b; border-radius:12px; padding:1rem; box-shadow:0 6px 30px rgba(0,0,0,.6); }
  #customThemeModal h3 { margin:0 0 .5rem 0; text-align:center; }
  #customThemeModal label{display:block;margin-top:.35rem;font-size:.9rem}
  #customThemeModal input[type="color"]{width:100%;height:34px;border-radius:6px;border:1px solid #333;padding:0}
  #customThemeList { list-style:none; padding:0; margin: .5rem 0; max-height:150px; overflow:auto; border:1px solid #333; border-radius:6px; padding:.4rem; }
  #customThemeList li { display:flex; justify-content:space-between; align-items:center; padding:.25rem .4rem; margin:.25rem 0; background:#161616; border-radius:6px; }
  #customThemeList button{ margin-left:.4rem; padding:.25rem .5rem; }

  /* iframe history */
  #historyFrame { display:none; position:fixed; z-index:11000; top:50%; left:50%; transform:translate(-50%,-50%); width:92%; height:78%; border:2px solid #50fa7b; background:#111; border-radius:8px; }
  #closeHistory { display:none; position:fixed; z-index:11001; top:6%; right:6%; padding:.5rem .8rem; border-radius:6px; background:#ff5555; color:#fff; }

  /* small screens */
  @media (max-width:600px){
    #searchBar { width:48%; }
    #customThemeModal { width:92%; }
  }
</style>
</head>
<body>
  <div id="topbar">
    <button id="modsbtn">Custom Themes</button>
    <input id="searchBar" placeholder="Search messages..." />
    <select id="themeSelector" aria-label="Select theme">
      <optgroup label="Classic Themes">
        <option value="dark">Dark</option>
        <option value="light">Light</option>
        <option value="sunset">Sunset</option>
      </optgroup>
      <optgroup label="Color Themes">
        <option value="red">Red</option>
        <option value="orange">Orange</option>
        <option value="yellow">Yellow</option>
        <option value="green">Green</option>
        <option value="teal">Teal</option>
        <option value="blue">Blue</option>
        <option value="purple">Purple</option>
        <option value="pink">Pink</option>
      </optgroup>
    </select>
  </div>

  <div id="chat" aria-live="polite"></div>

  <div id="inputArea">
    <input id="prompt" type="text" placeholder="Type your message..." autocomplete="off" />
    <button id="sendBtn">Send</button>
    <button id="clearMemory">Clear Memory</button>
    <button id="historyBtn">History</button>
    <button id="exportChatBtn" style="background:#00bfff;color:#fff;">Export Chat</button>
    <button id="importChatBtn" style="background:#50fa7b;color:#111;">Import Chat</button>
    <input id="importChatFile" type="file" accept="application/json" style="display:none">
  </div>

  <iframe id="historyFrame" title="Chat History"></iframe>
  <button id="closeHistory">Close History</button>

  <!-- Custom Theme Modal (hidden initially) -->
  <div id="customThemeModal" role="dialog" aria-hidden="true">
    <h3>Custom Theme Creator</h3>

    <label>Background</label>
    <input id="bgColor" type="color" value="#111">

    <label>Chat Background</label>
    <input id="chatBgColor" type="color" value="#222">

    <label>User Bubble</label>
    <input id="userColor" type="color" value="#6272a4">

    <label>AI Bubble</label>
    <input id="aiColor" type="color" value="#50fa7b">

    <label>System Text</label>
    <input id="systemColor" type="color" value="#ff5555">

    <h4 style="margin:.5rem 0 0 0">Saved Themes</h4>
    <ul id="customThemeList"></ul>

    <div style="display:flex; gap:.5rem; margin-top:.6rem; justify-content:center;">
      <button id="previewTheme">Preview</button>
      <button id="saveTheme">Save</button>
      <button id="exportThemeBtn" style="background:#00bfff;color:#fff;">Export Theme</button>
      <button id="importThemeBtn" style="background:#50fa7b;color:#111;">Import Theme</button>
      <input id="importThemeFile" type="file" accept="application/json" style="display:none;">
      <button id="closeTheme" style="background:#ff5555;color:#fff;">Close</button>
    </div>
  </div>

<script>
/* ---------- Setup ---------- */
if (!localStorage.getItem("deviceId"))
  localStorage.setItem("deviceId", crypto.randomUUID());
const deviceId = localStorage.getItem("deviceId");

const chat = document.getElementById("chat");
const promptEl = document.getElementById("prompt");
const sendBtn = document.getElementById("sendBtn");
const clearMemoryBtn = document.getElementById("clearMemory");
const historyBtn = document.getElementById("historyBtn");
const historyFrame = document.getElementById("historyFrame");
const closeHistory = document.getElementById("closeHistory");
const themeSelector = document.getElementById("themeSelector");

let chatHistory = JSON.parse(localStorage.getItem("chatHistory") || "[]");
let currentTheme = localStorage.getItem("theme") || "dark";

/* ---------- Themes ---------- */
const baseThemes = {
  dark:{background:"#111",chatBackground:"#222",userBubble:"#6272a4",aiBubble:"#50fa7b",systemText:"#ff5555",inputBackground:"#222",inputText:"#fff"},
  light:{background:"#f4f4f4",chatBackground:"#fff",userBubble:"#007bff",aiBubble:"#28a745",systemText:"#dc3545",inputBackground:"#fff",inputText:"#000"},
  sunset:{background:"#ffecd1",chatBackground:"#ffe4c4",userBubble:"#ff7f50",aiBubble:"#ffa07a",systemText:"#ff4500",inputBackground:"#fff5e6",inputText:"#333"},
  blue:{background:"#001a33",chatBackground:"#00264d",userBubble:"#3399ff",aiBubble:"#66ccff",systemText:"#99ccff",inputBackground:"#001a33",inputText:"#fff"},
};
function applyTheme(name){
  const theme = baseThemes[name] || baseThemes.dark;
  currentTheme = name;
  localStorage.setItem("theme", name);

  document.body.style.background = theme.background;
  document.body.style.color = theme.inputText;
  if(chat) chat.style.background = theme.chatBackground;
  if(promptEl){
    promptEl.style.background = theme.inputBackground;
    promptEl.style.color = theme.inputText;
  }
  document.querySelectorAll(".message.user").forEach(el=>el.style.background = theme.userBubble);
  document.querySelectorAll(".message.ai").forEach(el=>el.style.background = theme.aiBubble);
  document.querySelectorAll(".message.system").forEach(el=>el.style.color = theme.systemText);
}
applyTheme(currentTheme);

/* ---------- Message Handling ---------- */
function smoothScroll(){ chat.scrollTo({top:chat.scrollHeight,behavior:"smooth"}); }

function addMessage(sender,text,cls,opt={save:true}){
  const msg=document.createElement("div");
  msg.className=`message ${cls}`;
  const timestamp=new Date().toLocaleTimeString();
  msg.innerHTML=`<b>${sender}</b> <small style="opacity:.7">${timestamp}</small><br>${text}`;
  chat.appendChild(msg);
  smoothScroll();

  if(opt.save){
    chatHistory.push({sender,text,cls,time:timestamp});
    localStorage.setItem("chatHistory",JSON.stringify(chatHistory));
  }
}

/* ---------- Typing Indicator ---------- */
function showTyping(){
  if(document.getElementById("typing")) return;
  const t=document.createElement("div");
  t.id="typing"; t.className="message ai"; t.textContent="AI is typing...";
  chat.appendChild(t); smoothScroll();
}
function hideTyping(){const t=document.getElementById("typing");if(t)t.remove();}

/* ---------- Send Message ---------- */
async function sendMessage(){
  const text=(promptEl.value||"").trim();
  if(!text) return;
  addMessage("You",text,"user");
  promptEl.value="";
  showTyping();
  try{
    const res=await fetch(`/api?input=${encodeURIComponent(text)}&device=${deviceId}`);
    const reply=await res.text();
    hideTyping();
    addMessage("AI",reply,"ai");
  }catch(e){
    hideTyping();
    addMessage("System","Error contacting API.","system");
  }
}

/* ---------- Load Old Messages ---------- */
chatHistory.forEach(m=>addMessage(m.sender,m.text,m.cls,{save:false}));

/* ---------- Clear Memory ---------- */
if(clearMemoryBtn) clearMemoryBtn.addEventListener("click",async()=>{
  if(!confirm("Clear memory?")) return;
  try{await fetch(`/api?clear=true&device=${deviceId}`);}catch(e){}
  chat.innerHTML=""; chatHistory=[]; localStorage.removeItem("chatHistory");
  addMessage("System","Memory cleared!","system",{save:false});
});

/* ---------- History View (with timestamps) ---------- */
if(historyBtn) historyBtn.addEventListener("click",async()=>{
  try{
    const res=await fetch(`/api?view=history&device=${deviceId}`);
    const data=await res.json();
    let html=`<h3 style="text-align:center;">Device: ${deviceId}</h3>`;
    html+=`<table style="width:100%;border-collapse:collapse;color:#eee;">
      <tr><th>Sender</th><th>Class</th><th>Text</th><th>Time</th></tr>`;
    data.forEach(m=>{
      html+=`<tr>
        <td style="border-bottom:1px solid #333;padding:4px;">${m.sender||""}</td>
        <td style="border-bottom:1px solid #333;padding:4px;">${m.cls||""}</td>
        <td style="border-bottom:1px solid #333;padding:4px;">${m.text||""}</td>
        <td style="border-bottom:1px solid #333;padding:4px;">${m.time||""}</td>
      </tr>`;
    });
    html+=`</table>`;
    const blob=new Blob([`<body style='background:#111;color:#eee;font-family:sans-serif;padding:10px;'>${html}</body>`],{type:"text/html"});
    const url=URL.createObjectURL(blob);
    historyFrame.src=url;
    historyFrame.style.display="block";
    closeHistory.style.display="block";
  }catch(e){
    alert("Couldn't load server history.");
  }
});
if(closeHistory) closeHistory.addEventListener("click",()=>{
  historyFrame.style.display="none";
  closeHistory.style.display="none";
});

/* ---------- Theme Selector ---------- */
if(themeSelector){
  Object.keys(baseThemes).forEach(name=>{
    const opt=document.createElement("option");
    opt.value=name; opt.textContent=name.charAt(0).toUpperCase()+name.slice(1);
    themeSelector.appendChild(opt);
  });
  themeSelector.value=currentTheme;
  themeSelector.addEventListener("change",e=>applyTheme(e.target.value));
}

/* ---------- Send Button + Enter ---------- */
if(sendBtn) sendBtn.addEventListener("click", sendMessage);
if(promptEl) promptEl.addEventListener("keydown", e=>{if(e.key==="Enter")sendMessage();});
</script>
</body>
</html>
